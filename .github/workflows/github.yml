name: Upload VCMI mod archive

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Release tag (default: auto-detect)"
        required: false
      output_name:
        description: "Output name (default: vcmi-mod)"
        required: false
      overwrite:
        description: "Overwrite existing archive"
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          path: repo

      - name: Upload VCMI mod archive
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euox pipefail
          cd repo

          tag="${{ inputs.release_tag }}"
          name="${{ inputs.output_name }}"

          # If tag is empty (push trigger), default to latest
          [ -n "$tag" ] || tag=$(gh release view --json tagName --jq '.tagName')
          [ -n "$name" ] || name="vcmi-mod"

          out="$name.zip"
          assets=$(gh release view "$tag" --json assets)
          models=$(echo "$assets" | jq -r '.assets[] | select(.name | endswith(".onnx")) | .name')
          exists=$(echo "$assets" | jq --arg out "$out" '.assets | any(.name == $out)')

          $exists && [ "${{ inputs.overwrite }}" = "true" ] || { echo "output already exists"; exit 1; }

          for m in $models; do
            gh release download "$tag" --repo "${{ github.repository }}" -D models -p "$m"
          done

          cd ..
          mv repo "$name"
          zip -qr "$out" "$name" -x "$name/.git/*" -x "$name/.github/*"

          gh release upload "$tag" "$out" --repo "${{ github.repository }}" --clobber
