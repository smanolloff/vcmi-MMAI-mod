name: Upload VCMI mod archive

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Release tag (default: auto-detect)"
        required: true
      output_archive:
        description: "Output name (default: vcmi-mod.zip)"
        required: false
      overwrite:
        description: "Overwrite existing archive"
        required: true
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Upload VCMI mod archive
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euox pipefail

          tag="${{ inputs.release_tag }}"
          out="${{ inputs.output_archive}}"

          # If tag is empty (push trigger), default to latest
          [ -n "$tag" ] || tag=$(gh release view --json tagName --jq '.tagName')
          [ -n "$out" ] || out="vcmi-mod.zip"

          assets=$(gh release view "$tag" --json assets)
          models=$(echo "$assets" | jq -r '.assets[] | select(.name | endswith(".onnx")) | .name')
          exists=$(echo "$assets" | jq --arg out "$out" '.assets | any(.name == $out)')

          $exists && [ "${{ inputs.overwrite }}" = "true" ] || { echo "output already exists"; exit 1; }

          for m in $models; do
            gh release download "$tag" --repo "${{ github.repository }}" -D models -p "$m"
          done

          zip -qr "$out" . -x ".git/*" -x ".github/*"

          gh release upload "$tag" "$out" --repo "${{ github.repository }}" --clobber
